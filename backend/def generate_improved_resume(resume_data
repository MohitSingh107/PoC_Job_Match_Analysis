def generate_improved_resume(resume_data, gap_analysis, curriculum_text):
    """
    Generate improved resume using resume data (text and links), Step 2 analysis, and Coding Ninjas curriculum.
    
    Args:
        resume_data: Dictionary containing 'text' (resume text string) and 'links' (array of link objects with text and url)
        gap_analysis: Complete Step 2 analysis JSON (from full_analysis)
        curriculum_text: Coding Ninjas curriculum content
    """
    
    
    if not gap_analysis:
        raise ValueError("Step 2 analysis is required")
    
    system_message = """
# Role
You are an expert resume writer specializing in Data Analytics roles with deep knowledge of Coding Ninjas curriculum.

# Task
Generate an improved ATS-friendly Data Analytics resume using gap analysis insights and curriculum modules.

# Instructions (4 clear steps)

## Step 1: Skill Enhancement & Addition Strategy
Using the gap_analysis and curriculum provided:

### 1a. Identify Skills to Enhance
- Check each skill in gap_analysis.skills_analysis.has_skills
- For each skill, check if curriculum offers advanced topics
- Examples:
  - has "Excel" → can enhance with "Power Query" from curriculum
  - has "SQL" → can enhance with "CTEs, Window Functions" from curriculum
  - has "Python" → can enhance with "NumPy, Pandas, Matplotlib" from curriculum
- Output: skills_to_enhance = [{"base": "Excel", "enhanced": "Advanced Excel (Power Query)", "module": "Introduction to Data Analytics and Excel"}]

### 1b. Identify Skills to Add
- Use gap_analysis.skills_analysis.missing_skills (already filtered to curriculum)
- Map each missing skill to its curriculum module
- Output: skills_to_add = [{"skill": "Power BI", "module": "Data Visualization with PowerBi"}]

### 1c. Break Down Missing Keywords into Specifics
- Use gap_analysis.keywords_analysis.missing_keywords
- For each keyword, identify specific sub-skills from curriculum:
  - "SQL" → "CTEs (Common Table Expressions), Window Functions"
  - "Python" → "NumPy, Pandas, Matplotlib, Seaborn"
  - "Power BI" → "DAX, Power Query, Data Modeling"
  - "Excel" → "Power Query, Advanced Functions, Data Cleaning"
- Output: keyword_specifics = [{"keyword": "SQL", "specifics": ["CTEs", "Window Functions"], "module": "Analytics with SQL"}]

## Step 2: Project Strategy
Using gap_analysis.projects_analysis:

### 2a. Remove Irrelevant Projects
- Remove all projects listed in projects_to_remove
- These are non-DA projects that add no value

### 2b. Add Curriculum Case Studies as Projects
- Add case studies from curriculum modules that (equivalent to the length of gap_analysis.projects_analysis.projects_to_remove field):
  - Support skills being added/enhanced
  - Are most relevant to user_level (Fresher/Intermediate/Experienced)
- For each case study, create a project entry:
  - Project Name: Use case study name
  - Technologies: List relevant skills from that module
  - Description: 2-3 sentences about what analysis was done
- Output: projects_to_add = [{"name": "US Healthcare Dataset Analysis", "module": "Introduction to Data Analytics and Excel", "technologies": ["Excel", "Power Query"], "description": "..."}]

### 2c. Keep Relevant Projects
- Retain all projects from projects_to_keep with original description
- These are existing DA-relevant projects

### Final Project List
- New projects to be added is equivalent to the length of projects_to_remove field
- Order: Most relevant to DA first
- Balance: User's existing projects + curriculum case studies

## Step 3: Generate Improved Resume Text
Follow this ATS-friendly structure:

**CRITICAL**: While generating the improved resume text, if you think the original content or sections are good enough and don't require any enhancement, just keep it as it is.

### Header Section
[FULL NAME IN CAPS]
Email | Phone | Location | LinkedIn | GitHub 
(Only use the contact info present in the original resume and embedded links, remove the contact info that is not present in the original resume)

### Professional Summary
2 sentences maximum: [Professional Title based on user_level] with expertise in [top 2-4 skills including enhanced ones], experienced in [domain/projects], seeking to leverage [skills] for [DA role type].

### Technical Skills
Group into categories, display ONLY final enhanced versions (NO arrows):
• **Programming & Languages:** [enhanced skills + new skills]
• **Data Visualization Tools:** [Power BI, Excel, etc.]
• **Databases:** [SQL, MySQL, etc.]
• **Python Libraries:** [NumPy, Pandas, Matplotlib, Seaborn]
• **Other Tools:** [relevant tools]

**CRITICAL:** In resume text, show "Advanced Excel (Power Query)" NOT "Excel → Advanced Excel"

### Professional Experience / Work Experience
**MANDATORY RULES:**
- Include this section ONLY if ALL three conditions are met:
  1. user_level is NOT "Fresher" (must be "Intermediate" or "Experienced")
  2. Original resume has work experience section with dates
  3. Work experience is relevant to Data Analytics field or Techinal field like Software Development, etc.
  
- If user_level = "Fresher" → SKIP this entire section completely
- If work experience exists but not DA-related → SKIP this entire section completely
- When included: [Retain original descriptions, enhance with keywords if needed, keep original metrics]

### Education
**MANDATORY:** Use exact section name "Education" (NOT "Academic Details")
[Retain original education details exactly as provided]

### Projects
[Final project list from Step 2c]
For original projects:
- retain all the original details: project name, description, project links, duration
For curriculum case studies:
[Project Name] [Link to the project if present]
- Bullet points description (3 points) highlighting analysis, Technologies & Techniques used, outcomes

### Certifications
[Keep all original certifications]
ONLY ADD If certification with name Data Analytics doesn't exists:
- Certification in Data Analytics | Coding Ninjas | {CURRENT_YEAR}

### Sections other than the above sections should be removed

## Step 4: Classification & Tracking

### Pre-Check (MANDATORY)
Before classification, verify what exists in original resume:
- original_has_skills = gap_analysis.skills_analysis.has_skills
- A skill can ONLY be "enhanced" if its base form is in original_has_skills

### Classification Rules
1. **skills_enhanced:** Skills whose BASE form exists in original_has_skills
   - Format: ["Excel → Advanced Excel (Power Query)"]
   - ONLY if "Excel" is in original_has_skills
   
2. **skills_added:** Skills whose BASE form is NOT in original_has_skills
   - Format: ["Power BI", "Python"]
   - If original_has_skills = ["Excel", "SQL"], then Python goes here

3. **For Fresher with Zero Analytics Skills:**
   - If original_has_skills = [] or only has non-analytics skills
   - Then skills_added gets ALL curriculum skills
   - skills_enhanced remains EMPTY

**MANDATORY RULE:** A skill can ONLY appear in ONE array:
- Either skills_enhanced (if base exists and you're showing enhancement)
- OR skills_added (if it's a new standalone skill)
- NEVER in both  

**For Python libraries specifically:**
- Original has "Python" but NOT "NumPy, Pandas"
- These libraries should go to skills_enhanced ONLY

### Module Tracking
For each module used:
- module: Exact name from curriculum
- addresses_gaps: List specific skills/keywords it addresses
- projects_included: List case studies used as projects
- skills_added_from_module: New skills from this module
- skills_enhanced_by_module: Enhanced skills using this module

# Output Format (JSON only)
{
  "skill_strategy": {
    "skills_to_enhance": [
      {"base": "Excel", "enhanced": "Advanced Excel (Power Query)", "module": "..."}
    ],
    "skills_to_add": [
      {"skill": "Power BI", "module": "..."}
    ],
    "keyword_specifics": [
      {"keyword": "SQL", "specifics": ["CTEs", "Window Functions"], "module": "..."}
    ]
  },
  
  "project_strategy": {
    "projects_removed": ["project name"],
    "projects_kept": ["project name"],
    "projects_added": [
      {
        "name": "Case Study Name",
        "module": "...",
        "technologies": [],
        "description": "..."
      }
    ],
    "final_project_count": 3
  },
  
  "curriculum_mapping": {
    "modules_used": [
      {
        "module": "Exact module name",
        "addresses_gaps": ["skill1", "skill2"],
        "projects_included": ["case study name"],
        "skills_added_from_module": ["skill1"],
        "skills_enhanced_by_module": ["base → enhanced"]
      }
    ]
  },
  
  "improved_resume": {
    "improved_text": "Complete resume text following template structure. CRITICAL: Use 'Education' section name (NOT 'Academic Details'). For Freshers, SKIP 'Professional Experience' section entirely. In TECHNICAL SKILLS, show 'Advanced Excel (Power Query)' NOT 'Excel → Advanced Excel'",
    "skills_added": ["Power BI", "Python"],
    "skills_enhanced": ["Excel → Advanced Excel (Power Query)", "SQL → Advanced SQL (CTEs, Window Functions)", "Python → Python (NumPy, Pandas, Matplotlib, Seaborn)"],
    "projects_added": ["case study name"],
    "job_relevance_score": <0-100 integer>,
    "ats_score": <0-100 integer>,
    "estimated_improvement": <0-100 integer>
  },
  
  "modification_summary": "Enhanced [X] existing skills with [specific topics], added [Y] new skills from curriculum, replaced [Z] irrelevant projects with [curriculum case studies], improving job relevance by [%]."
}

# Critical Guidelines
- NEVER add metrics not in original resume
- NEVER invent work experience
- MUST verify base skill exists before marking as "enhanced"
- skill_enhanced & skill_added have unique skills in their respective arrays
- MUST use only curriculum skills/projects
- MUST preserve all original dates, education, contact info, metrics
- NO arrow notation (→) in resume text, ONLY in JSON tracking fields
- ALWAYS use "Education" as section name (NOT "Academic Details" or any other variant)
- For Freshers (user_level = "Fresher"), SKIP Professional Experience section completely
"""

    # Extract text and links from resume_data for clarity
    resume_text_content = resume_data.get('text', '')
    resume_links = resume_data.get('links', [])

    # region agent log
    agent_debug_log(
        hypothesis_id="H3",
        location="backend/app.py:LLM2:pre-call",
        message="LLM2 pre-call state",
        data={
            "resume_chars": len(resume_data.get('text', '') or ""),
            "links_count": len(resume_data.get('links', []) or []),
            "missing_skills": len(gap_analysis.get('skills_analysis', {}).get('missing_skills', []) if gap_analysis else 0),
            "missing_keywords": len(gap_analysis.get('keywords_analysis', {}).get('missing_keywords', []) if gap_analysis else 0)
        }
    )
    # endregion

    user_prompt = f"""
Generate improved Data Analytics resume using gap analysis and curriculum.

## Original Resume Data
**Resume Text:**
{resume_text_content}

**Embedded Links:**
{json.dumps(resume_links, indent=2)}

## Gap Analysis (from Step 2)
{json.dumps(gap_analysis, indent=2)}

## Coding Ninjas Curriculum
{json.dumps(curriculum_text, indent=2)}

## Current Year
{CURRENT_YEAR}

## Instructions
1. Use gap_analysis to understand what user has vs needs
2. Identify which curriculum modules address the gaps
3. Enhance existing skills where curriculum offers advanced topics
4. Break down missing keywords into specific curriculum topics
5. Replace irrelevant projects with curriculum case studies (max 3-4 total projects)
6. Generate improved resume following ATS template
7. Classify skills correctly (enhanced vs added) based on original has_skills
8. **CRITICAL:** Use "Education" section name (NOT "Academic Details")
9. **CRITICAL:** For user_level "Fresher", completely SKIP Professional Experience section

## Key Validation Rules
- Base skill must exist in gap_analysis.skills_analysis.has_skills to be "enhanced"
- If original has_skills is empty/minimal, most skills go to "skills_added"
- In resume text TECHNICAL SKILLS section: show only final form, NO arrows
- In JSON tracking fields: use arrows to show enhancement path
- Education section MUST be named "Education"
- Professional Experience section: Include ONLY if user_level is NOT "Fresher" AND has relevant DA work experience

## Expected Focus Areas Based on Gap Analysis
- User Level: {gap_analysis.get('user_level', 'Unknown')}
- Missing Skills to Add: {gap_analysis.get('skills_analysis', {}).get('missing_skills', [])}
- Missing Keywords: {gap_analysis.get('keywords_analysis', {}).get('missing_keywords', [])}
- Projects to Remove: {gap_analysis.get('projects_analysis', {}).get('projects_to_remove', [])}
- Projects to Keep: {gap_analysis.get('projects_analysis', {}).get('projects_to_keep', [])}
"""